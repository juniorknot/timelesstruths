!function(e){"function"==typeof define&&define.amd?define(["jquery"],e):e("object"==typeof exports?require("jquery"):jQuery)}(function(e){function t(e){return r.raw?e:encodeURIComponent(e)}function i(e){return r.raw?e:decodeURIComponent(e)}function o(e){return t(r.json?JSON.stringify(e):String(e))}function n(e){0===e.indexOf('"')&&(e=e.slice(1,-1).replace(/\\"/g,'"').replace(/\\\\/g,"\\"));try{return e=decodeURIComponent(e.replace(s," ")),r.json?JSON.parse(e):e}catch(t){}}function a(t,i){var o=r.raw?t:n(t);return e.isFunction(i)?i(o):o}var s=/\+/g,r=e.cookie=function(n,s,c){if(arguments.length>1&&!e.isFunction(s)){if("number"==typeof c&&(c={expires:c,path:"/"}),c=e.extend({},r.defaults,c),"number"==typeof c.expires){var l=c.expires,d=c.expires=new Date;d.setTime(+d+864e5*l)}return null===s?e.removeCookie(n,c):document.cookie=[t(n),"=",o(s),c.expires?"; expires="+c.expires.toUTCString():"",c.path?"; path="+c.path:"",c.domain?"; domain="+c.domain:"",c.secure?"; secure":""].join("")}for(var u=n?void 0:{},m=document.cookie?document.cookie.split("; "):[],f=0,h=m.length;h>f;f++){var p=m[f].split("="),$=i(p.shift()),v=p.join("=");if(n&&n===$){u=a(v,s);break}n||void 0===(v=a(v))||(u[$]=v)}return u};r.defaults={},e.removeCookie=function(t,i){return void 0===e.cookie(t)?!1:(e.cookie(t,"",e.extend({},i,{expires:-1})),!e.cookie(t))}});var TT=TT||{};TT.Utility={initTranslate:function(){$("#btn_translate").on("click",function(){$el=$("#translate"),$el.hasClass("init")||($.getScript("http://translate.google.com/translate_a/element.js?cb=TT.Utility.initGoogleTranslate"),$el.addClass("init")),$(this).hide(),$el.toggleClass("open"),ga("send","event","Translate",$el.hasClass("open")?"show":"hide")})},initGoogleTranslate:function(){new google.translate.TranslateElement({pageLanguage:"en"},"google_translate")},initTOC:function(){$(".toc .collapsible").each(function(){var e=$(this).attr("id");"open"!=$.cookie("t_"+e)&&$(this).addClass("min")}).on("click",function(){var e=$(this).attr("id");return $(this).toggleClass("min"),$.cookie("t_"+e,$(this).hasClass("min")?null:"open",{expires:1/24/12}),!1})},initNotes:function(){$(".page .note-ref").on("click",function(){return $el=$($(this).attr("href")),$el.css("top",$(this).position().top),$el.toggle(),(b=+$el.css("bottom").replace("px",""))<0&&$el.css("top",$el.position().top+b),!1}),$(".page .note-num").on("click",function(){$(this).parents(".note").hide()})},trackLink:function(e,t,i){try{ga("send","event",t,i),setTimeout('window.location = "'+e.href+'"',100)}catch(o){}return!1}},TT.Music={format:"pdf"==$.cookie("m_score_format")?"pdf":"sib",zoom:$.cookie("m_score_zoom")||760,notes:"+"==$.cookie("m_score_notes")?"shaped":"standard",init:function(){this.initScore()},initScore:function(){$("#score-format").on("click",function(){TT.Music.setScore("format",$(this).val())}),$("#score-notes").on("click",function(){TT.Music.setScore("notes",$(this).val())}),$("#score-zoom").on("click",function(){TT.Music.setZoom($(this).val())}),$(".help-link .show, .help-link .hide").on("click",function(){return $el=$(this).parents(".panel-toggle"),$el.toggleClass("hide"),ga("send","event","Score",($el.hasClass("hide")?"hide":"show")+" help"),!1})},setZoom:function(e){if(this.zoom!=e){this.zoom=e,$.cookie("m_score_zoom",this.zoom,1e3);var t=this.zoom,i=1.3*t+26;$("#score").width(t).height(i)}},setScore:function(e,t){if("format"==e){if(this.format==t)return;this.format=t,$.cookie("m_score_format","pdf"==this.format?"pdf":null,1e3)}if("notes"==e){if(this.notes==t)return;this.notes=t,$.cookie("m_score_notes","shaped"==this.notes?"+":null,1e3)}var i="data-src-"+this.format+"-"+this.notes,o=$("#score"),n=o.attr(i);if(n)o.html('<div class="wrapper">'+("sib"==this.format?'<object id="s_sib" type="application/x-sibelius-score" data="'+n+'"><param name="src" value="'+n+'" /><param name="scorch_minimum_version" value="3000" /><param name="scorch_shrink_limit" value="100" /><param name="shrinkwindow" value="0" /></object>':'<iframe id="s_pdf" frameborder="0" src="'+n+'"></iframe>')+"</div>");else{var a=encodeURI("Request: "+$("title").text().replace(/ >.+/,"")+" (."+this.format+")"),s=encodeURI("I would like to have the ."+this.format+" sheet music for this song added to your priority list. Thank you."),r=encodeURI(window.location.href);o.html('<div class="wrapper"><div class="error-message"><p>Sorry, the sheet music is not available in this format (.'+TT.Music.format+'):</p><ul><li><a class="blue" href="'+$("body").attr("data-level")+"contact/?subject="+a+"&amp;comments="+s+"&amp;url="+r+'">Request sheet music</a></li></ul></div></div>')}}},TT.Admin={init:function(){$("html").addClass("admin"),this.initEditable()},initEditable:function(){$("[data-editable]").append('<a class="edit" title="edit" href="#edit"></a>'),$("[data-editable]").on("click",".edit",function(){return"loaded"==$(this).parents("[data-editable]").attr("data-status")?!1:(TT.Admin.edit($(this).parent(),"get",function(e){$('[data-editable="'+e.edit+'"]').data("originalValue",e.value).attr("data-status","loaded").find(".edit").before("<textarea>"+e.value+"</textarea>"),console.log("get",e)}),!1)}),$("[data-editable]").on("change","textarea",function(){var e="true",t=$(this).val(),i=new DOMParser,o=i.parseFromString("<xml>"+t+"</xml>","text/xml");"parsererror"==o.documentElement.nodeName&&(e="invalid"),$(this).attr("data-modified",e)}),$("[data-editable]").on("click","[data-modified] + .edit",function(){TT.Admin.edit($(this).parent(),"set",function(e){console.log("set",e),window.location.reload()})})},edit:function(e,t,i){var o=e.attr("data-editable"),n="http://localhost/admin.timelesstruths.org/Editable",a={view:!1,action:t,edit:o};if("set"==t){var e=e.find("textarea");if("invalid"==e.attr("data-modified"))return!1;a.value=escape(e.val())}$.get(n,a,i,"json")}},TT.Dev={init:function(){$("body").append("<div id='dev'>Dev | <button data-opt='exit'>exit</button></dev>"),$('#dev [data-opt="exit"]').click(function(){$.cookie("dev",!1,{path:"/"}),window.location.reload()})}},$(function(){TT.Utility.initNotes(),"localhost"==window.location.hostname&&TT.Admin.init(),$("html").hasClass("dev")&&TT.Dev.init()});